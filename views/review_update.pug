extends layout.pug 

block head
  link(rel='stylesheet', href='/public/assets/css/review.css', type='text/css')
  script(src='https://code.jquery.com/jquery-3.5.1.min.js', type="text/javascript")
  script(src='https://unpkg.com/axios/dist/axios.min.js')
  

block content 
  div.review_id(data-id=`${data[0].review_id}`) 

  div.reviews 
    //- - for (const i in data)
      //- p #{data[i].user_id}
    p username: #{data[0].username}
    img.profile_img(src= `${data[0].profile_image}`, alt='')
    //- a(href=`/review_info?id=${data[i].review_id}&locale=${data.locale}`)
    h3 review# #{data[0].review_id}
    img.review_img(src= `${data[0].image}`, alt='')
    h3.review_title #{data[0].review_title}
    p #{data[0].content}
    p created at #{data[0].created_dt}
    p updated at #{data[0].updated_dt}

    a(href=`/movie?id=${data[0].movie_id}&locale=${data.locale}`)
      img.movie_poster(src= `${data[0].poster}`, alt='')
      p #{data[0].title}

  div.review_submit
    form.review_form
      div#review_id(name='movieId' data-id=`${data[0].review_id}`) 
      //- div
        //- input#review_movie_id(type='text' name='movieId' value=`${data.movie_id}`)
      div Title
        br
        input#review_title(type='text' name='title' maxlength='255' value=`${data[0].review_title}`)
      div Content
        br
        textarea#review_content(type='text' name='content') #{data[0].content}
      div Image (optional)
        br
        input(name='image' type='file')        
      button#update_review Update

  script(type='text/javascript').
    let locale = !{locale}
    
    async function updateReview (e) {
      e.preventDefault();

      if ( $('#review_title').val() == "" || $('#review_content').val() == "" ) {
        alert("please fill in title and content before submit");
        return
      } 
      try{

        const form = $('.review_form')[0];
        const formData = new FormData(form);
        console.log(form)

        let reviewId = $('#review_id').data('id')
        formData.append('reviewId', reviewId);
        console.log(formData)
        
        await axios({
          method: 'PATCH',
          url: '/api/1.0/user/review',
          data: formData,
          headers: {
            'Content-Type': 'multipart/form-data',
          },
        });

      window.location.href = `info?id=${reviewId}&locale=${locale}`;
      }
      catch(err){
          console.log(err);
      }    
    };
    
    $('#update_review').on('click', updateReview);