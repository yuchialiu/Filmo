extends layout.pug 

block head
  link(rel='stylesheet', href='/public/assets/css/review.css', type='text/css')
  link(rel='stylesheet', href='/public/assets/css/profile.css', type='text/css')
  link(rel='stylesheet', href='/public/assets/css/save_button.css', type='text/css')

  script(src='https://code.jquery.com/jquery-3.5.1.min.js', type="text/javascript")
  script(src='https://unpkg.com/axios/dist/axios.min.js')

block content 
  body 
    div.main_outer
      div(id="sidebar-container" class="sidebar-expanded d-none d-md-block")
        ul(class="list-group")
          a(href="#" data-toggle="sidebar-colapse" class="bg-dark list-group-item list-group-item-action d-flex align-items-center")
            div(class="d-flex w-100 justify-content-start align-items-center")
              span#collapse-icon.fa.fa-2x.mr-3
              span#collapse-text.menu-collapsed #{lang.account.collapse}
          a(href=`/profile?locale=${locale}` class="menu-collapsed d-flex w-100 justify-content-start align-items-center")
            i(class="fas fa-user-circle")
            span.tablinks #{lang.account.my_account}
          a(href=`/profile/review?locale=${locale}` class="menu-collapsed d-flex w-100 justify-content-start align-items-center")  
            i(class="fas fa-book-reader")
            span.tablinks #{lang.account.my_reviews}
          a#sidebar_selected(href=`/store/review?locale=${locale}` class="menu-collapsed d-flex w-100 justify-content-start align-items-center")
            i(class="fas fa-newspaper")
            span.tablinks#sidebar_selected_text #{lang.account.saved_reviews}
          a(href=`/store/movie?locale=${locale}` class="menu-collapsed d-flex w-100 justify-content-start align-items-center")
            i(class="fas fa-film")
            span.tablinks #{lang.account.saved_movies}
          a(class="menu-collapsed d-flex w-100 justify-content-start align-items-center")
            i(class="fas fa-sign-out-alt")
            span#logout_btn #{lang.account.logout}

      -if (!data.length)
        h3.no_data_title #{lang.account.no_saved_review}
      -else  
        div.outer_review_account
          - for (let i = 0; i < data.length ; i++)
            div.review_account
              div.item
                div.review_movie.d-flex
                  div
                    a(href=`/movie?id=${data[i].movie_id}&locale=${locale}`)
                      img.movie_poster_saved(src=`${data[i].movie_poster}`, alt='Poster')
                  div   
                    //- a(href=`/review/info?id=${data[i].review_id}&locale=${locale}`)
                    h4.review_title #{data[i].review_title}
                    p.movie_title #{data[i].movie_title}     
                  div.save_review          
                    button.delete_saved_review(type='submit' value=`${data[i].review_id}`) 

              div.d-flex
                div.user
                  div#picture_outline
                    img.profile_img(src= `${data[i].profile_image}`, alt='Profile Image')
                  div.name_date.flex-column
                    p.username #{data[i].username}

                div
                  img.review_img(src=`${data[i].image}`, alt='')
                  p.review_text #{data[i].content}             
              div.bottom
                p.review_created_dt #{data[i].created_dt}
                  //- p.review_num Review# #{data[i].review_id}
                  //- p.review_updated_dt Updated at #{data[i].updated_dt}

  script(src='/public/assets/js/profile_sidebar.js')

  script(type='text/javascript').
    $(async () => {
      const locale = !{ locale_string };

      // logout
      async function logout(e) {
        e.preventDefault();        
        
        await axios({
          method: 'get',
          url: '/api/1.0/user/logout',
        });
        alert("You have successfully logged out!");
        window.location.href = `/home?locale=${locale}`;
      }

      $('#logout_btn').on('click', logout);      

      //- const locale = !{ locale };
      $('.delete_saved_review').on('click', async (e) => {
        e.preventDefault();
        const review_id = e.target.value;
        console.log(review_id)

        try {
          const data = JSON.stringify({
            review_id,
          });

          const result = await axios({
            method: 'delete',
            url: '/api/1.0/user/store/review',
            data,
            headers: {
              'Content-Type': 'application/json',
            },
          });

          alert('review removed');
          window.location.href = `review?locale=${locale}` ;

        } catch {
          alert('review not existed');
          console.log('err: ', err);
        }

      });
    });  