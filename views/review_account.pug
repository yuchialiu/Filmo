extends layout.pug 

block head
  link(rel='stylesheet', href='./public/assets/css/review.css', type='text/css')
  script(src='https://code.jquery.com/jquery-3.5.1.min.js', type="text/javascript")
  script(src='https://unpkg.com/axios/dist/axios.min.js')
  

block content 
  body 
  .tab
    a(href='profile')
      button.tablinks My Account
    a(href='profile_review?locale=en-US')  
      button.tablinks My Reviews
    a(href='user_store_review')
      button.tablinks Saved Reviews
    a(href='user_store_movie')
      button.tablinks Saved Movies
  
  div#myReviews 
    h1 #{title}
    h1 #{data}

  script.

    let token = localStorage.getItem('Authorization');
    
    window.addEventListener('load', async function (event) {
      try {        
      if (!token) {
        alert("please sign in or sign up first");
        console.log("no token, please sign in or sign up first");
        window.location.href = "login";
        return;
      }
      await auth_member();
      showReviewByAccount(auth_result);
    } catch(err) {
      console.log(err);
    }
    });

    //authorize member
    let auth_result;
    const locale = document.URL.split("=")[1];


      async function auth_member() {
      try {
        auth_result = await axios({
          method: 'GET',
          url: `/api/1.0/user/review?locale=${locale}`,
          responseType: 'json',
          headers: {
            Authorization: `${localStorage.getItem('Authorization')}`,
          },
          });

        return auth_result;
      } catch(err) { 
        console.log(err);
      }
    }

    function showReviewByAccount(auth_result){
      let info = auth_result.data.data;
      console.log(info)

      for (let i in info){
        const d = $('<div></div>').addClass('review_div')
        const a_review = $('<a></a>').attr('href', `/`)
        const h3_review = $('<p></p>').addClass('review_num').html(`review# ${info[i].id}`)

        const img_review = $('<img>').addClass('review_img').attr('src', info[i].image)
        const p_content = $('<p></p>').addClass('review_content').html(info[i].content)
        const p_created = $('<p></p>').addClass('review_created_dt').html(`created at ${(info[i].created_dt).slice(0,10)}`)
        const p_updated = $('<p></p>').addClass('review_updated_dt').html(`updated at ${(info[i].updated_dt).slice(0,10)}`)

        const a_movie = $('<a></a>').attr('href', `/movie?id=${info[i].movie_id}&locale=${locale}`)
        const h3_movie = $('<p></p>').addClass('movie_title').html(info[i].title)
        const img_movie = $('<img>').addClass('movie_poster').attr('src', info[i].poster)

        let div_review = a_review
        div_review = div_review.append(a_review)
        div_review = div_review.append(h3_review)
        div_review = div_review.append(img_review)
        div_review = div_review.append(p_content)
        div_review = div_review.append(p_created)
        div_review = div_review.append(p_updated)


        let div_movie = a_movie 
        div_movie = div_movie.append(h3_movie)
        div_movie = div_movie.append(img_movie)

        $('#myReviews').append(d)
        $('#myReviews').append(div_review)


        $('#myReviews').append(div_movie)        

      }
    }